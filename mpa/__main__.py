#!/usr/bin/env python3
"""
Copyright (C) 2024 Axel Koolhaas

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Lesser General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
"""

"""Main module."""
import atexit
import signal
import sys
from typing import List
from device.manager import DeviceManager


# Manager for devices
device_manager = DeviceManager()

def exit_handler():
    """Handle clean exit"""
    for device in device_manager.devices:
        device.disconnect()
    print("Exiting...")

def ctrl_c_handler(signum, frame):
    """Handle Ctrl+C (SIGINT)"""
    exit_handler()
    sys.exit(1)

def exception_handler(exception_type, exception, traceback):
    """Handle uncaught exceptions"""
    print(f"Exception: {exception_type.__name__}: {exception}")
    exit_handler()

'''
# FUTURE
def monitor_devices():
    """Monitor for device changes in the background"""
    while True:
        # Check for device changes
        current_android_devices = get_android_devices()
        current_ios_devices = get_ios_devices()
        
        # If there's a change, update the main menu or notify the user
        # This is where you might refresh your device list or user interface
        
        # Wait a bit before checking again
        time.sleep(5)

# Set up and start the device monitoring thread
monitoring_thread = threading.Thread(target=monitor_devices)
monitoring_thread.daemon = True
monitoring_thread.start()
'''

def show_banner() -> str:
    print("""
 _______  _____  _______
 |  |  | |_____] |_____|
 |  |  | |       |     |
 Automate your mobsec flow

""")

if __name__ == '__main__':
    show_banner()
    #TODO add argparse
    #TODO license first time run

    # Ensure clean exit
    atexit.register(exit_handler)
    signal.signal(signal.SIGINT, ctrl_c_handler)
    sys.excepthook = exception_handler

    print("Initializing...")

    # Validate dependencies for different devices
    if not device_manager.has_android_dependencies:
        print("ADB not found. Please install Android SDK Platform Tools.")
        print("Android support will be disabled")
    if not device_manager.has_ios_dependencies:
        print("idevice_id not found. Please install libimobiledevice.")
        print("Ios support will be disabled")
    
    # Get all connected devices
    device_manager.add_devices()

    # Do things with the devices
    print('-'*80)
    for device in device_manager.devices:
        print(device)
        #device.mirror_screen()
        #device.http_redirect_enable()
        device.http_redirect_disable()
    
    for device in device_manager.devices:
        print(f"{device.execute_transient_command('whoami')}")