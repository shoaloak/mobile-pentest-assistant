#
# Copyright (C) 2024 Axel Koolhaas
# 
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Lesser General Public License for more details.
# 
# You should have received a copy of the GNU Lesser General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

import os
import socket
import subprocess
from typing import Optional

def find_available_host_port(
    host: str = 'localhost',
    start_port: int = 1024,
    end_port: int = 65535
) -> Optional[int]:
    """Find an available port on the host machine"""
    for port in range(start_port, end_port + 1):
        try:
            with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
                s.settimeout(0.3)
                s.connect((host, port))
        except (ConnectionRefusedError, socket.timeout):
            # available
            return port
        except Exception:
            pass  # Handle other exceptions if necessary
    return None  # No available port found in the specified range

def get_project_path() -> str:
    current_script_directory = os.path.dirname(os.path.realpath(__file__))
    project_root = os.path.dirname(current_script_directory)
    return project_root + '/'

def exec_applestatement(statement: str) -> str:
    """Execute an AppleScript statement"""
    p = subprocess.run(['osascript', '-e', statement], capture_output=True)
    return p.stdout.decode()

def exec_applescript(script, args) -> dict:
    """Execute an AppleScript"""
    p = subprocess.run(['osascript', script, *args], capture_output=True)
    return {'stdout': p.stdout.decode(), 'stderr': p.stderr.decode()}
