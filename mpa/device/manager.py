"""
Copyright (C) 2024 Axel Koolhaas

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Lesser General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
"""

import subprocess
from device.android import AndroidDevice
from device.ios import IosDevice

def get_android_devices():
    # Run adb command to get list of devices
    result = subprocess.run(
        ['adb', 'devices'],
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True)
    # Skip the first line of the output which is a header
    lines = result.stdout.strip().split('\n')[1:]

    android_devices = []
    for line in lines:
        # Ensure the line has a tab, which separates the ID and the status
        if "\t" in line:
            device_id, _ = line.split("\t")
            android_devices.append(AndroidDevice(device_id))

    return android_devices

def get_ios_devices():
    try:
        result = subprocess.check_output(["idevice_id", "--list"])
        ids = result.decode('utf-8').strip().split('\n')
        # Filter out empty lines
        ios_devices = [IosDevice(id) for id in ids if id] 
        return ios_devices
    except subprocess.CalledProcessError:
        return []

def get_devices():
    return get_android_devices() + get_ios_devices()