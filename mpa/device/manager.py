"""
Copyright (C) 2024 Axel Koolhaas

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Lesser General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
"""

import subprocess
import logging
import shutil
from device import BaseDevice
from device.android import AndroidDevice
from device.ios import IosDevice

class DeviceManager():
    """Object that manages mobile devices."""

    def __init__(self):
        self.devices: list[BaseDevice] = []

        # Android support requires ADB
        self.has_android_dependencies = shutil.which('adb') is not None
        # Ios support requires libimobiledevice
        self.has_ios_dependencies = shutil.which('idevice_id') is not None

    def add_android_devices(self) -> bool:
        """Add Android devices to the device list."""
        if not self.has_android_dependencies:
            return False

        try:
            # List Android devices
            result = subprocess.check_output(["adb", "devices"], text=True)
            lines = result.strip().split('\n')[1:] # Skip header line

            ids = []
            for line in lines:
                # Ensure the line has a tab, which separates the ID and the status
                if "\t" in line:
                    device_id, _ = line.split("\t")
                    ids.append(device_id)

            # Create AndroidDevices for all IDs
            self.devices.extend([AndroidDevice(id) for id in ids])
        except subprocess.CalledProcessError as e:
            logging.error(f"Failed to get Android devices. {e}")
            return False

        return True

    def add_ios_devices(self) -> bool:
        """Add iOS devices to the device list."""
        if not self.has_ios_dependencies:
            return False

        try:
            # List iOS devices
            result = subprocess.check_output(["idevice_id", "--list"],
                                             text=True)
            ids = result.strip().split('\n')

            # Create IosDevices for all IDs, and ensure id is not empty
            self.devices.extend([IosDevice(id) for id in ids if id])
        except subprocess.CalledProcessError as e:
            logging.error(f"Failed to get iOS devices. {e}")
            return False

        return True

    def add_devices(self, clear=True) -> bool:
        """Add all connected devices to the device list."""
        if clear:
            # Clear device list to avoid duplicates
            self.devices.clear()

        android_success = self.add_android_devices()
        ios_success = self.add_ios_devices()

        return android_success and ios_success